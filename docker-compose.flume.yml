# ===================================================================
# Docker Compose Configuration for Flume Services
# ===================================================================
services:
  # --- Service cho Agent Tổng hợp (collector) ---
  flume-collector:
    build: ./flume
    container_name: flume-collector
    volumes:
      # Gắn file cấu hình của collector vào container
      - ./flume/collector/collector.conf:/opt/flume/conf/flume.conf
      - ./data/flume/agents/collector/checkpoint:/opt/flume/checkpoint
      - ./data/flume/agents/collector/data:/opt/flume/data

      - ./data/out/access:/flume-out/access
      - ./data/out/error:/flume-out/error
    command: /opt/flume/bin/flume-ng agent --conf /opt/flume/conf --conf-file /opt/flume/conf/flume.conf --name a1 -Dflume.root.logger=INFO,console
    ports:
      # Mở port 41414 để nhận dữ liệu từ các agent con
      - "41414:41414"
    # depends_on:
    #   # Đảm bảo Kafka đã sẵn sàng trước khi collector khởi động
    #   - kafka
    networks: [appnet]

  # --- Service cho Agent Thu thập trên Web Server 1 ---
  flume-agent-web1:
    build: ./flume
    container_name: flume-agent-web1
    volumes:
      # Gắn file cấu hình của agent web1
      - ./flume/agents/agent-web1.conf:/opt/flume/conf/flume.conf
      # Gắn thư mục log của nginx-web1 vào để Flume có thể đọc (read-only)
      - ./data/logs/web1:/var/log/nginx:ro
      - ./data/flume/agents/web1/checkpoint:/opt/flume/checkpoint
      - ./data/flume/agents/web1/data:/opt/flume/data
    command: /opt/flume/bin/flume-ng agent --conf /opt/flume/conf --conf-file /opt/flume/conf/flume.conf --name a1 -Dflume.root.logger=INFO,console
    depends_on:
      # # Đảm bảo web1 và collector đã sẵn sàng
      # - nginx-web1
      - flume-collector
    networks: [appnet]

  # --- Service cho Agent Thu thập trên Web Server 2 ---
  flume-agent-web2:
    build: ./flume
    container_name: flume-agent-web2
    volumes:
      # Gắn file cấu hình của agent web2
      - ./flume/agents/agent-web2.conf:/opt/flume/conf/flume.conf
      # Gắn thư mục log của nginx-web2
      - ./data/logs/web2:/var/log/nginx:ro
      - ./data/flume/agents/web2/checkpoint:/opt/flume/checkpoint
      - ./data/flume/agents/web2/data:/opt/flume/data
    command: /opt/flume/bin/flume-ng agent --conf /opt/flume/conf --conf-file /opt/flume/conf/flume.conf --name a1 -Dflume.root.logger=INFO,console
    depends_on:
      # - nginx-web2
      - flume-collector
    networks: [appnet]

  # --- Service cho Agent Thu thập trên Web Server 3 ---
  flume-agent-web3:
    build: ./flume
    container_name: flume-agent-web3
    volumes:
      # Gắn file cấu hình của agent web3
      - ./flume/agents/agent-web3.conf:/opt/flume/conf/flume.conf
      # Gắn thư mục log của nginx-web3
      - ./data/logs/web3:/var/log/nginx:ro
      - ./data/flume/agents/web3/checkpoint:/opt/flume/checkpoint
      - ./data/flume/agents/web3/data:/opt/flume/data
    command: /opt/flume/bin/flume-ng agent --conf /opt/flume/conf --conf-file /opt/flume/conf/flume.conf --name a1 -Dflume.root.logger=INFO,console
    depends_on:
      # - nginx-web3
      - flume-collector
    networks: [appnet]

networks:
  appnet:
    external: true
