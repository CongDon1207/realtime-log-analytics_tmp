# ===================================================================
# Flume Aggregator Agent Configuration
# Nhận Avro từ các web-agent, route theo header `type`,
# ghi Kafka vào 2 topic web-access-logs / web-error-logs
# ===================================================================

a1.sources  = avro_source
a1.channels = access_channel error_channel
a1.sinks    = kafka_access_sink kafka_error_sink

# --- Avro Source ---
a1.sources.avro_source.type = avro
a1.sources.avro_source.bind = 0.0.0.0
a1.sources.avro_source.port = 41414

# Route theo header 'type'
a1.sources.avro_source.selector.type   = multiplexing
a1.sources.avro_source.selector.header = type
a1.sources.avro_source.selector.mapping.access = access_channel
a1.sources.avro_source.selector.mapping.error  = error_channel
a1.sources.avro_source.selector.default        = access_channel

# --- FileChannels (durable) ---
a1.channels.access_channel.type = file
a1.channels.access_channel.checkpointDir = /opt/flume/checkpoint/access
a1.channels.access_channel.dataDirs      = /opt/flume/data/access
# (khuyến nghị) giới hạn transaction để mượt IO:
a1.channels.access_channel.capacity = 1000000
a1.channels.access_channel.transactionCapacity = 5000

a1.channels.error_channel.type = file
a1.channels.error_channel.checkpointDir = /opt/flume/checkpoint/error
a1.channels.error_channel.dataDirs      = /opt/flume/data/error
a1.channels.error_channel.capacity = 500000
a1.channels.error_channel.transactionCapacity = 2000

# # --- Kafka Sinks ---
# # Dùng FQCN KafkaSink + prefix "kafka." cho mọi thuộc tính
a1.sinks.kafka_access_sink.type = org.apache.flume.sink.kafka.KafkaSink
a1.sinks.kafka_access_sink.kafka.bootstrap.servers = kafka:9092
a1.sinks.kafka_access_sink.kafka.topic = web-logs
# # batch Flume -> Kafka producer
a1.sinks.kafka_access_sink.kafka.key.header = host
a1.sinks.kafka_access_sink.kafka.flumeBatchSize = 200
a1.sinks.kafka_access_sink.kafka.producer.acks = 1
a1.sinks.kafka_access_sink.kafka.producer.linger.ms = 10
a1.sinks.kafka_access_sink.kafka.producer.compression.type = snappy

a1.sinks.kafka_error_sink.type = org.apache.flume.sink.kafka.KafkaSink
a1.sinks.kafka_error_sink.kafka.bootstrap.servers = kafka:9092
a1.sinks.kafka_error_sink.kafka.topic = web-errors
a1.sinks.kafka_error_sink.kafka.key.header = host
a1.sinks.kafka_error_sink.kafka.flumeBatchSize = 200
a1.sinks.kafka_error_sink.kafka.producer.acks = 1
a1.sinks.kafka_error_sink.kafka.producer.linger.ms = 10
a1.sinks.kafka_error_sink.kafka.producer.compression.type = snappy

# --- Sinks ghi ra file thay cho Kafka ---
#a1.sinks = file_access_sink file_error_sink

# access -> thư mục access
a1.sinks.file_access_sink.type = file_roll
a1.sinks.file_access_sink.sink.directory = /flume-out/access
a1.sinks.file_access_sink.sink.rollInterval = 60
a1.sinks.file_access_sink.sink.batchSize = 200
a1.sinks.file_access_sink.sink.serializer = TEXT
a1.sinks.file_access_sink.sink.serializer.appendNewline = true
a1.sinks.file_access_sink.channel = access_channel

# error -> thư mục error
a1.sinks.file_error_sink.type = file_roll
a1.sinks.file_error_sink.sink.directory = /flume-out/error
a1.sinks.file_error_sink.sink.rollInterval = 60
a1.sinks.file_error_sink.sink.batchSize = 200
a1.sinks.file_error_sink.sink.serializer = TEXT
a1.sinks.file_error_sink.sink.serializer.appendNewline = true
a1.sinks.file_error_sink.channel = error_channel


# --- Bindings ---
a1.sources.avro_source.channels      = access_channel error_channel
a1.sinks.kafka_access_sink.channel   = access_channel
a1.sinks.kafka_error_sink.channel    = error_channel
