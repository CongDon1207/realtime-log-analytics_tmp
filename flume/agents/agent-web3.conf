# ===================================================================
# Flume Agent Configuration for web3
# Mục tiêu: Đọc access.log và error.log, gửi đến Aggregator.
# ===================================================================

# Đặt tên cho các thành phần của agent này
a1.sources = taildir_source
a1.channels = file_channel
a1.sinks = avro_sink

# --- Cấu hình Source (Nguồn vào) ---
# Sử dụng TAILDIR để theo dõi thư mục, rất tốt cho việc log rotate.
a1.sources.taildir_source.type = TAILDIR
# File này sẽ lưu vị trí đã đọc cuối cùng để không đọc lại log cũ.
a1.sources.taildir_source.positionFile = /opt/flume/data/taildir_position.json

# Định nghĩa 2 nhóm file để đọc đồng thời access và error log
a1.sources.taildir_source.filegroups = f_access f_error
a1.sources.taildir_source.filegroups.f_access = /var/log/nginx/access.json.log
a1.sources.taildir_source.filegroups.f_error  = /var/log/nginx/error.log

# Dán "nhãn" (header) để phân biệt loại log
# Rất quan trọng cho việc phân luồng ở bước sau
a1.sources.taildir_source.headers.f_access.type = access
a1.sources.taildir_source.headers.f_error.type = error

# Dán "nhãn" để biết log này đến từ server nào
a1.sources.taildir_source.headers.f_access.host = web3
a1.sources.taildir_source.headers.f_error.host  = web3

# --- Cấu hình Channel (Kênh đệm) ---
# Sử dụng File Channel để đảm bảo dữ liệu không bị mất nếu agent sập.
a1.channels.file_channel.type = file
a1.channels.file_channel.checkpointDir = /opt/flume/checkpoint
a1.channels.file_channel.dataDirs = /opt/flume/data

# --- Cấu hình Sink (Đầu ra) ---
# Sử dụng Avro Sink để gửi dữ liệu đến Agent Tổng hợp trung tâm.
a1.sinks.avro_sink.type = avro
# 'flume-collector' là tên service Docker của Agent Tổng hợp (sẽ tạo sau).
a1.sinks.avro_sink.hostname = flume-collector
a1.sinks.avro_sink.port = 41414

# --- Gắn các thành phần lại với nhau ---
a1.sources.taildir_source.channels = file_channel
a1.sinks.avro_sink.channel = file_channel