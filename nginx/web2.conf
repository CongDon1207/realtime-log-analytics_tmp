worker_processes  auto;
events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  
  log_format json escape=json
    '{ "time":"$time_iso8601","ts":$msec,'
    '"remote":"$remote_addr","hostname":"web2",'
    '"method":"$request_method","path":"$uri","status":$status,'
    '"bytes":$body_bytes_sent,"rt":$request_time }';
  access_log /var/log/nginx/access.json.log json;
  error_log  /var/log/nginx/error.log  error;

  # Upstream với network latency để tạo response time
  upstream external_service {
    server httpbin.org:80;
    keepalive 2;
  }

  server {
    listen 8082;
    server_name web2;

    # Fast baseline endpoint
    location / { 
      return 200 'ok-web2'; 
    }

    # Variable latency endpoint với diverse errors
    location /api {
      proxy_pass http://external_service/get;
      proxy_set_header Host httpbin.org;
      proxy_connect_timeout 2s;
      proxy_read_timeout 2s;
    }

    # Slow API endpoint để tạo real nginx errors
    location /slowapi {
      proxy_pass http://external_service/delay/8;
      proxy_set_header Host httpbin.org;
      proxy_connect_timeout 3s;
      proxy_read_timeout 3s;
    }

    # HTTP Error codes (4xx/5xx) - consolidated
    location ~ ^/(notfound|forbidden|unavailable|timeout|badgateway|ratelimit|oops)$ {
      if ($uri = "/notfound") { return 404 'resource not found'; }
      if ($uri = "/forbidden") { return 403 'access forbidden'; }
      if ($uri = "/unavailable") { return 503 'service unavailable'; }
      if ($uri = "/timeout") { return 504 'gateway timeout'; }
      if ($uri = "/badgateway") { return 502 'bad gateway error'; }
      if ($uri = "/ratelimit") { return 429 'too many requests - rate limited'; }
      return 500 'error-web2';
    }

    # Dynamic endpoints với random responses
    location /random {
      if ($request_time ~ "0\.[0-4]") { return 200 'success'; }
      if ($request_time ~ "0\.[5]") { return 400 'client error'; }
      if ($request_time ~ "0\.[6]") { return 429 'rate limited'; }
      if ($request_time ~ "0\.[7]") { return 503 'service unavailable'; }
      if ($request_time ~ "0\.[8]") { return 504 'gateway timeout'; }
      return 502 'bad gateway';
    }

    location /status {
      if ($request_time ~ "0\.[0-6]") { return 200 'operational'; }
      if ($request_time ~ "0\.[7-8]") { return 503 'degraded'; }
      return 500 'down';
    }

    # Health endpoint
    location /health {
      if ($request_time ~ "0\.[0-7]") { return 200 'healthy'; }
      return 503 'unhealthy';
    }

    # Redirect endpoint
    location /redirect {
      return 301 http://httpbin.org/redirect/1;
    }
  }
}
